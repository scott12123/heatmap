<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Signal Heatmap</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script>
  fetch('/data')
    .then(r => r.json())
    .then(raw => {
      const items = Array.isArray(raw) ? raw : [raw];
      // Filter out entries without valid latitude and longitude
      const points = items
        .filter(i => i.latitude !== undefined && i.longitude !== undefined) // Ensure lat/lng exist
        .map(i => [
          parseFloat(i.latitude),
          parseFloat(i.longitude),
          i.scan_result && i.scan_result.signal_quality
            ? i.scan_result.signal_quality / 100
            : 0.5 // Default intensity if signal_quality is missing
        ]);

      const map = L.map('map').setView([0, 0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      if (points.length) {
        const avgLat = points.reduce((a, p) => a + p[0], 0) / points.length;
        const avgLng = points.reduce((a, p) => a + p[1], 0) / points.length;
        const avgSignalStrength = (
          points.reduce((a, p) => a + (p[2] * 100), 0) / points.length
        ).toFixed(2); // Calculate average signal strength and format to 2 decimals

        map.setView([avgLat, avgLng], 13);

        const heatLayer = L.heatLayer(points, {
          radius: 25,
          gradient: {
            0.0: 'blue',   // 0% intensity
            0.3: 'green',  // 30% intensity
            0.6: 'yellow', // 60% intensity
            1.0: 'red'     // 100% intensity
          }
        }).addTo(map);

        // Add a popup to display the average signal strength
        const popup = L.popup()
          .setLatLng([avgLat, avgLng])
          .setContent(`Average Signal Strength: ${avgSignalStrength}%`);

        // Show the popup on mouse hover
        map.on('mouseover', () => {
          popup.openOn(map);
        });

        // Hide the popup when the mouse leaves the map
        map.on('mouseout', () => {
          map.closePopup(popup);
        });
      } else {
        console.error('No valid points to display on the map.');
      }
    })
    .catch(err => console.error('Failed to load data', err));
</script>
</body>
</html>
