<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Signal Heatmap</title>
  <link rel="stylesheet" href="/leaflet/leaflet.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }

    .leaflet-control-layers-expanded {
      display: block !important;
      background: white;
      padding: 5px;
      border-radius: 5px;
      box-shadow: 0 1px 5px rgba(0, 0, 0, 0.65);
    }

    .leaflet-control-layers-expanded input[type="radio"] {
      display: inline-block;
      margin-right: 5px;
    }

    .leaflet-control-layers-expanded label {
      display: inline-block;
      margin-bottom: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="/leaflet/leaflet.js"></script>
  <script src="/leaflet/leaflet-heat.js"></script>
  <script>
    fetch('/data')
      .then(r => r.json())
      .then(raw => {
        const items = Array.isArray(raw) ? raw : [raw];

        // Ignore payloads without valid lat and long
        const points = items
          .filter(i => i.latitude !== undefined && i.longitude !== undefined)
          .map(i => [
            parseFloat(i.latitude),
            parseFloat(i.longitude),
            i.scan_result && i.scan_result.signal_quality
              ? i.scan_result.signal_quality / 100
              : 0.5 // Default point intensity if signal_quality is missing
          ]);

        const map = L.map('map').setView([0, 0], 2);

        // Standard map
        const defaultLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors'
        });

        // Satellite map
        const satelliteLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
          attribution: '© Google Maps',
          subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });

        // Start with default layer
        defaultLayer.addTo(map);

        // Add points to make heatmap
        if (points.length) {
          const bounds = L.latLngBounds(points.map(point => [point[0], point[1]]));
          map.fitBounds(bounds);

          const heatLayer = L.heatLayer(points, {
            radius: 35,
            gradient: {
              0.0: 'blue',   // 0% intensity
              0.3: 'green',  // 30% intensity
              0.6: 'yellow', // 60% intensity
              1.0: 'red'     // 100% intensity
            }
          }).addTo(map);

          // Switch between layers
          const layerControl = L.control.layers({
            'Default View': defaultLayer,
            'Satellite View': satelliteLayer
          }).addTo(map);

          // Always show the map controls
          const layerControlElement = document.querySelector('.leaflet-control-layers');
          if (layerControlElement) {
            layerControlElement.classList.add('leaflet-control-layers-expanded');
          }

          // Popup to show nearest signal strength to mouse
          const popup = L.popup();
          const radiusThreshold = 50; // Meters mouse to point

          // Find the closest point to the mouse
          function findClosestPoint(latlng) {
            let closestPoint = null;
            let minDistance = Infinity;

            points.forEach(point => {
              const distance = map.distance(latlng, L.latLng(point[0], point[1]));
              if (distance < minDistance) {
                minDistance = distance;
                closestPoint = point;
              }
            });

            return { closestPoint, minDistance };
          }

          // Update popup
          map.on('mousemove', (e) => {
            const { closestPoint, minDistance } = findClosestPoint(e.latlng);
            if (closestPoint && minDistance <= radiusThreshold) {
              const signalStrength = (closestPoint[2] * 100).toFixed(2);
              popup
                .setLatLng(e.latlng)
                .setContent(`Signal Strength: ${signalStrength}%`)
                .openOn(map);
            } else {
              map.closePopup(popup);
            }
          });
        } else {
          console.error('No valid points to display on the map.');
        }
      })
      .catch(err => console.error('Failed to load data', err));
  </script>
</body>
</html>
